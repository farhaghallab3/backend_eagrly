# Classifieds API Documentation

This document summarizes the public API endpoints for the Classifieds Django backend and includes example requests you can pass to an AI or use directly in a React app.

Base URL (example): `http://127.0.0.1:8000/`
All API routes below are mounted under the `/api/` prefix (except Swagger/Redoc and JWT routes).

**Auth**:
- POST `/api/token/` -- obtain JWT access & refresh tokens
  - Body (JSON): `{ "username": "<username_or_email>", "password": "<password>" }`
  - Response: `{ "access": "<jwt_access>", "refresh": "<jwt_refresh>" }`
- POST `/api/token/refresh/` -- refresh access token
  - Body (JSON): `{ "refresh": "<jwt_refresh>" }`

Include protected requests Authorization header:
- Header: `Authorization: Bearer <access_token>`

OpenAPI / Swagger:
- GET `/swagger.json` -- raw OpenAPI JSON (drf-yasg)
- GET `/swagger/` -- interactive Swagger UI
- GET `/redoc/` -- Redoc UI

Primary endpoints (generated by DRF DefaultRouter):
- Users
  - `GET  /api/users/`            -- list users (staff) / current user (non-staff)
  - `POST /api/users/`            -- create/register user (AllowAny)
  - `GET  /api/users/{id}/`       -- retrieve user (owner or admin)
  - `PUT/PATCH /api/users/{id}/`  -- update user
  - `DELETE /api/users/{id}/`     -- delete user

- Categories
  - `GET  /api/categories/`       -- list categories
  - `POST /api/categories/`       -- create category (admin-only)
  - `GET  /api/categories/{id}/`  -- retrieve
  - `PUT/PATCH /api/categories/{id}/` -- update
  - `DELETE /api/categories/{id}/`    -- delete

- Products
  - `GET  /api/products/`         -- list products (public)
    - Supports filtering: `?category=<id>`, `?price__lt=<val>`, `?price__gt=<val>`, `?university=<val>`, `?faculty=<val>`, `?status=<val>`, `?seller__id=<id>`
    - Supports search: `?search=<text>` (title, description)
    - Supports ordering: `?ordering=price` or `?ordering=-created_at`
  - `POST /api/products/`         -- create product (authenticated; regular users limited to 2 products)
  - `GET  /api/products/{id}/`    -- retrieve product
  - `PUT/PATCH /api/products/{id}/` -- update (owner or admin)
  - `DELETE /api/products/{id}/`  -- delete

- Packages
  - `GET /api/packages/`          -- list subscription/package plans
  - `POST /api/packages/`         -- create (admin)
  - `GET /api/packages/{id}/`     -- retrieve
  - `PUT/PATCH /api/packages/{id}/` -- update
  - `DELETE /api/packages/{id}/`  -- delete

- Payments
  - `GET /api/payments/`          -- list (authenticated)
  - `POST /api/payments/`         -- create payment record (authenticated)
  - `GET /api/payments/{id}/`     -- retrieve
  - `PUT/PATCH /api/payments/{id}/` -- update
  - `DELETE /api/payments/{id}/`  -- delete

- Reviews
  - `GET /api/reviews/`           -- list reviews (authenticated)
  - `POST /api/reviews/`          -- create review (authenticated; requires active payment)
  - `GET /api/reviews/{id}/`      -- retrieve
  - `PUT/PATCH /api/reviews/{id}/` -- update (owner or admin)
  - `DELETE /api/reviews/{id}/`   -- delete

- Chats
  - `GET  /api/chats/`            -- list chats (owner/admin)
  - `POST /api/chats/`            -- create chat
  - `GET  /api/chats/{id}/`       -- retrieve chat
  - `GET  /api/messages/`         -- list messages (authenticated)
  - `POST /api/messages/`         -- create message (sender auto-filled)

- Reports
  - `GET  /api/reports/`          -- list reports (authenticated)
  - `POST /api/reports/`         -- create report
  - `GET  /api/reports/{id}/`     -- retrieve
  - `PUT/PATCH /api/reports/{id}/` -- update (owner/admin)
  - `DELETE /api/reports/{id}/`   -- delete

- Chatbot (AI Product Assistant)
  - `POST /api/chatbot/chatbot/`  -- send a user message to the AI assistant with product search capabilities
    - Body (JSON): `{ "message": "Do you have a calculator?" }`
    - Response (JSON):
      ```json
      {
        "reply": "We have a Scientific Calculator available from Ahmed for $49.99 (new condition). Click on 'Ahmed' to see the full product details!",
        "products": [
          {
            "id": 9,
            "title": "Scientific Calculator",
            "price": 49.99,
            "condition": "new",
            "category": "Mathematics Tools",
            "seller": {
              "id": 2,
              "name": "Ahmed",
              "username": "ahmed123"
            }
          }
        ]
      }
      ```
    - Notes: When the AI finds products, it includes both the text reply and product data. The frontend should render seller names as clickable links to open product details. Products are only from active inventory.

Example HTTP requests (curl)
- Obtain token:

```bash
curl -X POST "https://your-server.example.com/api/token/" -H "Content-Type: application/json" -d '{"username":"alice","password":"secret"}'
```

- Use token to GET products:

```bash
curl -X GET "https://your-server.example.com/api/products/" -H "Authorization: Bearer <ACCESS_TOKEN>"
```

- Create a product (example using `fetch` in React with JSON; if product uses files use FormData):

```js
// POST JSON example
fetch("https://your-server.example.com/api/products/", {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${accessToken}`,
  },
  body: JSON.stringify({ title: 'Nice Laptop', description: 'Good condition', price: 200 })
})
.then(r => r.json())
.then(data => console.log(data))
```

```js
// POST multipart/form-data for file uploads
const form = new FormData();
form.append('title', 'Nice Laptop');
form.append('price', 200);
form.append('image', fileInput.files[0]);
fetch('https://your-server.example.com/api/products/', {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${accessToken}` },
  body: form
}).then(res => res.json()).then(console.log);
```

Chatbot example (React `fetch`):

```js
fetch('https://your-server.example.com/api/chatbot/chatbot/', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ message: 'Hello, can you summarize my listing?' })
}).then(r => r.json()).then(data => console.log(data.reply));
```

How to pass this doc to an AI to generate a React integration
- Provide the AI with this `docs/api.md` file or the OpenAPI JSON from `/swagger.json`.
- Ask the AI to generate:
  - A JS/TS API client module that exposes functions matching endpoints (e.g., `login`, `getProducts`, `createProduct`, `sendChatbotMessage`).
  - React hooks (e.g., `useProducts`, `useAuth`, `useChatbot`) that call the client and handle loading/error states.
  - Example components and a simple auth flow storing `access`/`refresh` in memory or `localStorage` (note: consider security for refresh tokens).

Suggested prompt to give an AI (concise):

"You have the following API specification (attach `docs/api.md` or paste `/swagger.json`). Generate a small React client:
- `apiClient.js` with methods: `login(username,password)`, `refreshToken(refresh)`, `getProducts(params)`, `getProduct(id)`, `createProduct(data)`, `sendChatbotMessage(message)`.
- React hooks: `useAuth`, `useProducts`, `useChatbot` using `fetch` and `localStorage` for tokens.
- Include example components: `Login`, `ProductList`, `ProductForm`, `ChatbotWidget`.
- Assume a base URL variable `API_BASE = process.env.REACT_APP_API_BASE`.
- Provide code only, avoid external UI libraries." 

Notes & gotchas
- Use the `/swagger.json` OpenAPI output if you want the AI to auto-generate typed clients (many tools can generate TypeScript from OpenAPI).
- JWT `refresh` token should be stored carefully; prefer httpOnly secure cookie in production. LocalStorage is simpler for demos.
- File uploads require multipart/form-data and cannot be sent as JSON.
- Some endpoints have additional permission rules (see viewsets):
  - Creating a review requires an active payment; creating products is limited for regular users.

If you want, I can:
- Save an extracted `swagger.json` locally (call the running server's `/swagger.json`) â€” requires server running.
- Generate a simple `apiClient.js` and React hooks in `frontend/` directory you can copy into your React app.

Next step: generate a ready-to-use `apiClient.js` + hooks for React (or produce an OpenAPI-based TypeScript client). Reply with which option you prefer.
